			   SAVEFILE FORMAT
			   ---------------

This document represents a work in progress. The save format described
here will evolve before finalization for 0.8.

The old save file format used a custom compressor and was very finicky
about padding and alignment for machines that were not even in use
anymore. It was also extremely fragile and hard for modders to extend.

The new save format seeks to alleviate these problems.

			    GENERAL FORMAT
			    --------------

All multibyte values are little-endian. There are no alignment
restrictions inherent in the format.

The save file begins with a 32-bit identifier and version number (a
"magic number") that identifies it as a particular version of an UQM
save file. If the format changes in a way that older versions of UQM
cannot read it, either the identifier or the version number should
change.

The vanilla UQM system has a save number of 0x01534d55, which, if
interpreted as a byte stream is UMS (Ur-quan Masters Save) and a
binary 1 (version 1). Vanilla UQM reserves the tags "UMSx" for all x
for use to evolve the core save format. Modders are encouraged, but
not required, to also use the fourth bit as a version number.

Following the 32-bit file identifier comes a series of chunks. All
chunks have the same general format: a 32-bit tag, similar to that of
the file as a whole, followed by a 32-bit integer specifying the size
of the chunk, and then that many bytes of data.

Bytes in a chunk tag should all be in the range 0x20-0x7E -- that is,
they should be printable ASCII characters. Chunks are traditionally
referred to by their tag names.

Chunks whose tag has a least significant byte in the range 0x41-0x5a,
inclusive---that is to say, whose names start with a capital
letter---are mandatory. If you extend the set of mandatory chunks, you
must increase the version of the file. Tags that do not start with a
capital letter may be ignored by other versions of UQM that otherwise
understand that data version.

(Why would you want to have ignorable bits of save file? Such chunks
may contain helpful but ancillary information. For instance, at the
time of this writing, there is an outstanding bug that life forms are
un-stunned if you save and load in orbit. One could add a new chunk
that tracks the stunned status of life forms on the planet you're in
orbit around, and just revert to the old behavior if it's not there or
if you're running on a version without that fix. Such an ancillary
data chunk would have a tag like "stun" or "biot".)

Note also that despite being "mandatory", it is not the case that all
chunks will be present in all save files. Different data is saved out
depending on the situation you saved in.

Unless otherwise specified, chunks may be stored in any order in the
save file.

			   CHUNK INVENTORY
			   ---------------

- "Summ": Summary. This chunk must come first. This chunk
  carries the flagship configuration information and some overview
  information that is displayed on the savegame view screen. It is of
  variable length, because the last element of this chunk is the name
  of the save as chosen by the user.

- "GlSt": Global State. This chunk must come second, after
  Summ. Represents most of the data in the global state structure in
  globdata.h.

- "GmSt": Game State. This chunk must come third, after GlSt. This is
  the gigantic bitfield that the GET_GAME_STATE macros modify. It is
  variably-sized; excess bytes in this array will be ignored, and if
  there are insufficient bytes in the save file, the remaining bits
  will be initialized to zero. Modders setting extra event flags may
  be able to import a legacy game into a sensible state by choosing
  their defaults judiciously.

- "Evts": Events. An array of values describing scripted future
  events.

- "Enct": Encounters. Details of battle groups that are pursuing you
  through HyperSpace.

- "RacQ": Available Race Queue. Which species are active in the game,
  where they are, etc. Corresponds to avail_race_q.

- "IGpQ": Interplanetary Group Queue. Battlegroup information for
  ships in your current star system, if you're in a current star
  system. It is currently unclear whether or not this ever needs to
  exist, but in keeping with legacy logic, it will appear whenever you
  are in a star system but not in the middle of an encounter.

- "NpcQ": NPC Queue. Battlegroup information for ships you are in the
  middle of encountering. This should only appear if your loaded
  activity is "IN_ENCOUNTER" and loading the game will trigger the red
  alert.

- "ShpQ": Ship Queue. Battlegroup information for your flagship's
  escort fleet.

- "Star": Star Description. Basic indexing information to indicate
  which star system you are in.

- "SISF": Star Info State File. An index into which planetside
  resources you have investigated and collected. See
  doc/devel/statefiles for more details.

- "DGSF": Defined Group State File. Battlegroup information for
  space-based encounters dictated by the plot. See
  doc/devel/statefiles for more details.

- "RGSF": Random Group State File. Battlegroup information for random
  encounters in interplanetary space. See doc/devel/statefiles for
  more details.

- "Scan": Scanner Masks. NOT YET IMPLEMENTED; WILL REPLACE SISF. It
  might just be a rename with better endianness enforcement, though;
  the SISF dump is pretty well-structured as it is.

- "DGrp": Defined Group. NOT YET IMPLEMENTED; WILL REPLACE DGSF. Will
  carry an enumeration id to indicate which of the defgrps it is
  (that's currently intrinsic to the game state bit array) and will
  also have a bit indicating whether or not it is the "current"
  defgrp. If no defgrp is current, BattleGroupRef is 0; otherwise,
  BattleGroupRef is the defgrp file offset that corresponds to the
  current system. There will be one DGrp chunk for each system with an
  active defgrp record.

- NOT YET DESIGNED: RGSF also needs to be replaced with one or more
  chunk types. This will likely be similar to the DGrp chunks, but
  there are stronger constraints on repetition here.

		   THINGS LEFT TO DO BEFORE MERGING
		   --------------------------------

- Actually enforce little-endianness of everything that hits the disk.
  - Everything that isn't a State File now respects this.
  - State files are going to require more work (see below).

- There are 448 bits in GmSt that are actually indices into DGSF. They
  shouldn't be there. In fact, they shouldn't even be in the
  GAME_STATE array either. They should be an array of DWORDs living
  independently in the global state
  - In preparation for this, the GRPOFFS state has been moved to the
    end of the state array. We'll be able to eradicate it once the
    state files are no longer part of the save.

- The State Files are (except maybe for Star Info) a horrible mess and
  we should not be replicating them in the save file. We should
  instead be regenerating them from more structured forms.
  - Once we do this we can start computing new values for the GRPOFFS
    state and the BattleGroupRef based on the new chunks. We can then
    remove the GRPOFFS bits from the GmSt chunk and the BattleGroupRef
    from the GlSt chunk. From there we can see our way to eradicating
    the state file abstraction entirely, but that will be quite a bit
    more work.
